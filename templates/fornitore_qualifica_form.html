
{% extends "base.html" %}
{% block title %}{{ 'Nuovo fornitore' if mode=='nuovo' else 'Rivaluta fornitore' }}{% endblock %}
{% block content %}
<div class="container py-4">
  <h1 class="mb-3">{{ 'Inserisci nuovo fornitore' if mode=='nuovo' else 'Rivaluta fornitore' }}</h1>
  <form method="post">
    {{ form.csrf_token }}
    <div class="row g-3">
      <div class="col-md-6">{{ form.nome.label(class="form-label") }} {{ form.nome(class="form-control") }}</div>
      <div class="col-md-6">{{ form.contatto.label(class="form-label") }} {{ form.contatto(class="form-control") }}</div>
      <div class="col-md-8">{{ form.indirizzo.label(class="form-label") }} {{ form.indirizzo(class="form-control") }}</div>
      <div class="col-md-4">{{ form.citta.label(class="form-label") }} {{ form.citta(class="form-control") }}</div>
      <div class="col-md-12">{{ form.tipologia.label(class="form-label") }} {{ form.tipologia(class="form-control") }}</div>
    </div>
    <hr class="my-4">
    <h5 class="mb-3">Domande di qualifica (Requisito × Importanza = Punteggio per domanda)</h5>
    <div class="row g-3">
      
{% for i in range(1,11) %}
  {% set req_name = 'q' ~ i ~ '_req' %}
  {% set imp_name = 'q' ~ i ~ '_imp' %}
  {% set req_field = form[req_name] %}
  {% set imp_field = form[imp_name] %}
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-body">
        <div class="mb-2 fw-semibold">{{ req_field.label.text }}</div>
        <div class="d-flex align-items-end gap-2">
          <div class="flex-grow-1">
            <label class="form-label">Requisito (1–5)</label>
            {{ req_field(class="form-select") }}
          </div>
          <div class="flex-grow-1">
            <label class="form-label">Importanza (1–6)</label>
            {{ imp_field(class="form-select") }}
          </div>
          <div class="text-center" style="min-width: 110px;">
            <div class="small text-muted">Punteggio</div>
            <div class="fs-4 mb-0" id="score_{{ i }}">0</div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endfor %}

    </div>
    <div class="mt-3">{{ form.note.label(class="form-label") }} {{ form.note(class="form-control") }}</div>
    <div class="d-flex justify-content-between align-items-center mt-4">
      <div class="d-flex align-items-center gap-2">
        <div class="fw-bold">Punteggio finale:</div>
        <div class="fs-3 mb-0" id="final_score">0</div>
      </div>
      {{ form.submit(class="btn btn-success btn-lg") }}
    </div>
  </form>
</div>
<script>
function updateScores(){
  let total = 0, count = 0;
  for(let i=1;i<=10;i++){
    const r = parseInt(document.querySelector(`[name=q${i}_req]`).value||"0");
    const im = parseInt(document.querySelector(`[name=q${i}_imp]`).value||"0");
    const s = (r && im) ? (r*im) : 0;
    document.getElementById("score_"+i).innerText = s;
    if(s>0){ total += s; count++; }
  }
  const avg = count ? (total / count) : 0;
  document.getElementById("final_score").innerText = Math.round(avg*100)/100;
}
document.addEventListener("change", (e)=>{
  if(e.target && (e.target.name||'').match(/^q\d+_(req|imp)$/)){ updateScores(); }
});
document.addEventListener("DOMContentLoaded", updateScores);
</script>
{% endblock %}
